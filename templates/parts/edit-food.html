
<div id="wrapper-edit-food-modal"></div>



<script>

    const editFoodModal = new Modal('edit-food', 'Редактировать еду', true, true, false);
    editFoodModal.cancelButton.innerText = "Назад";

    {
        const rootId = editFoodModal.modalId;

        const addFoodNameId = `${rootId}-add-food-name`;
        const addProteinsId = `${rootId}-add-food-proteins`;
        const addFatsId = `${rootId}-add-food-fats`;
        const addCarbsId = `${rootId}-add-food-carbs`;
        const addKcalId = `${rootId}-add-food-kcal`;
        const addFoodButtonId = `${rootId}-add-food-button`;

        const addDishNameId = `${rootId}-add-dish-name`;
        const editDishNameId = `${rootId}-editDishNameId`;
        const editDishFoodListId = `${rootId}-editDishFoodListId`;
        const editDishFoodListSelectId = `${rootId}-editDishFoodListSelectId`;
        const editDishOutOfStockId = `${rootId}-editDishOutOfStockId`;
        const editDishAddNewBtnId = `${rootId}-editDishAddNewBtnId`;
        const editDishAmountInputId = `${rootId}-editDishAmountInputId`;
        const addDishButtonId = `${rootId}-add-dish-button`;

        const searchFoodId = `${rootId}-search-food`;
        const allFoodsId = `${rootId}-all-foods`;

        const searchDishId = `${rootId}-search-dish`;
        const allDishesId = `${rootId}-all-dishes`;

        const foodTabButtonId = `${rootId}-food-tab-btn`;
        const dishTabButtonId = `${rootId}-dish-tab-btn`;
        const foodTabId = `${rootId}-food-tab`;
        const dishTabId = `${rootId}-dish-tab`;

        const newDishTab = `${rootId}-newDishTab`;
        const editDishTab = `${rootId}-editDishTab`;

        editFoodModal.onClose(() => {
            startEditMealGroup(currEditingMealGroup);
        });

        editFoodModal.onOpen(() => {

            editFoodModal.setHtml(`
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
              <label id=${foodTabButtonId}  class="btn btn-outline-primary w-50 py-05" for="btnradio1">Еда</label>

              <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
              <label id=${dishTabButtonId} class="btn btn-outline-primary w-50 py-05" for="btnradio2">Блюдо</label>
            </div>

            <div id="${foodTabId}">

                <hr>

                <h5>Новая еда</h5>

                <div class="input-group mb-2-5">
                  <input id="${addFoodNameId}" type="text" class="form-control" placeholder="Название">
                </div>

                <div class="d-flex">
                    <div class="input-group">
                      <span class="input-group-text py-025 proteins-bg">Б</span>
                      <input id="${addProteinsId}" type="text" class="form-control py-025" placeholder="0">
                      <span class="input-group-text py-025 fats-bg">Ж</span>
                      <input id="${addFatsId}" type="text" class="form-control py-025" placeholder="0">
                      <span class="input-group-text py-025 carbs-bg">У</span>
                      <input id="${addCarbsId}" type="text" class="form-control py-025" placeholder="0">
                      <span class="input-group-text py-025 kcal-bg">Кк</span>
                      <input id="${addKcalId}" type="text" class="form-control py-025" placeholder="0">
                    </div>
                    <button id="${addFoodButtonId}" class="btn btn-primary ms-2 py-025" disabled>Добавить</button>
                </div>

                <hr>

                <h5>Добавленная еда</h5>

                <div class="input-group mb-3">
                  <span class="input-group-text">
                      <i class="fa-solid fa-magnifying-glass"></i>
                  </span>
                  <input id="${searchFoodId}" type="text" class="form-control" placeholder="Искать по названию">
                </div>

                <div id="${allFoodsId}"></div>
            </div>

            <div id="${dishTabId}" class="d-none">
                <hr>

                <div id=${newDishTab}>
                    <h5>Новое блюдо</h5>
                    <div class="d-flex">
                        <div class="input-group">
                          <input id="${addDishNameId}" type="text" class="form-control" placeholder="Название">
                        </div>
                        <button id="${addDishButtonId}" class="btn btn-primary ms-2 py-025" disabled>Добавить</button>
                    </div>

                    <hr>

                    <h5>Добавленные блюда</h5>

                    <div class="input-group mb-3">
                      <span class="input-group-text">
                          <i class="fa-solid fa-magnifying-glass"></i>
                      </span>
                      <input id="${searchDishId}" type="text" class="form-control" placeholder="Искать по названию">
                    </div>

                    <div id="${allDishesId}"></div>

                </div>
                <div id=${editDishTab} class="d-none">
                    <h5>Редактировать блюдо</h5>

                    <div class="d-flex align-items-start">
                        <div class="input-group me-2 mb-2-5">
                           <input id="${editDishNameId}" type="text" class="form-control" placeholder="Название">
                        </div>
                        ${HtmlPresets.switch(editDishOutOfStockId, '', '', false, true, 6)}
                    </div>

                    <hr>

                    <div id=${editDishFoodListId}></div>
                </div>




            </div>
            `);

            onClick(foodTabButtonId, () => {
                showElem(foodTabId);
                hideElem(dishTabId);
            });

            onClick(dishTabButtonId, () => {
                hideElem(foodTabId);
                showElem(dishTabId);
            });



            onInput(searchFoodId, renderFoods);
            onInput(searchDishId, renderDishes);
            renderFoods();
            renderDishes();


            const checkAddFoodButton = () => {
                let name = byId(addFoodNameId).value.trim();
                let proteins = handleFloatField(addProteinsId, 0, 100);
                let fats = handleFloatField(addFatsId, 0, 100);
                let carbs = handleFloatField(addCarbsId, 0, 100);
                let kcal = handleNumberField(addKcalId, 0, 999);

                byId(addFoodButtonId).disabled =
                    !(name.length && proteins != null && fats != null && carbs != null && kcal != null);
            };

            for (let field of [addFoodNameId, addProteinsId, addFatsId, addCarbsId, addKcalId]) {
                onInput(field, checkAddFoodButton);
            }

            onClick(addFoodButtonId, async () => {
                let name = byId(addFoodNameId).value.trim();
                let proteins = handleFloatField(addProteinsId, 0, 100);
                let fats = handleFloatField(addFatsId, 0, 100);
                let carbs = handleFloatField(addCarbsId, 0, 100);
                let kcal = handleNumberField(addKcalId, 0, 999);

                byId(addFoodButtonId).disabled = true;

                let result = await _post("/api/food/new" ,{
                    name: name,
                    proteins: proteins,
                    fats: fats,
                    carbs: carbs,
                    kcal: kcal,
                });

                if (result.id) {
                    allFoods[result.id] = result;
                }

                for (let field of [addFoodNameId, addProteinsId, addFatsId, addCarbsId, addKcalId]) {
                    byId(field).value = "";
                }

                renderFoods();
            });

            const checkAddDishButton = () => {
                let name = byId(addDishNameId).value.trim();
                byId(addDishButtonId).disabled = !(name.length);
            };

            for (let field of [addDishNameId]) {
                onInput(field, checkAddDishButton);
            }

            onClick(addDishButtonId, async () => {
                let name = byId(addDishNameId).value.trim();

                byId(addDishButtonId).disabled = true;

                let result = await _post("/api/dish/new" ,{
                    name: name,
                });

                if (result.id) {
                    allDishes[result.id] = result;
                }

                for (let field of [addDishNameId]) {
                    byId(field).value = "";
                }

                renderDishes();
            });
        });

        const renderFoods = () => {

            let search = byId(searchFoodId).value.toLowerCase().trim();
            let searchTerms = search.split(/\s+/);

            let foodButtonKey = `data-ft-food-btn-id`;
            let foodNameIdKey = `data-ft-food-name-id`;
            let foodProteinsIdKey = `data-ft-food-proteins-id`;
            let foodFatsIdKey = `data-ft-food-fats-id`;
            let foodCarbsIdKey = `data-ft-food-carbs-id`;
            let foodKcalIdKey = `data-ft-food-kcal-id`;

            let foodsHtml = ``;
            for (let food of Object.values(allFoods)) {
                let lowerCaseFoodName = food.name.toLowerCase();
                if (!searchTerms.every(term => lowerCaseFoodName.includes(term))) {
                    continue;
                }

                foodsHtml = `
                <hr>
                <div class="">
                    <div class="input-group mb-2-5">
                        <input ${foodNameIdKey}=${food.id} type="text" class="form-control" value="${food.name}">
                    </div>
                    <div class="d-flex">
                        <div class="input-group">
                          <span class="input-group-text py-025 proteins-bg">Б</span>
                          <input ${foodProteinsIdKey}=${food.id} type="text" class="form-control py-025" value="${food.proteins}">
                          <span class="input-group-text py-025 fats-bg">Ж</span>
                          <input ${foodFatsIdKey}=${food.id} type="text" class="form-control py-025" value="${food.fats}">
                          <span class="input-group-text py-025 carbs-bg">У</span>
                          <input ${foodCarbsIdKey}=${food.id} type="text" class="form-control py-025" value="${food.carbs}">
                          <span class="input-group-text py-025 kcal-bg">Кк</span>
                          <input ${foodKcalIdKey}=${food.id} type="text" class="form-control py-025" value="${food.kcal}">
                        </div>
                        <button ${foodButtonKey}=${food.id} class="btn btn-primary ms-2 py-025" disabled>Изменить</button>
                    </div>
                </div>

                ` + foodsHtml;
            }

            byId(allFoodsId).innerHTML = foodsHtml;

            const checkEditButton = (foodId) => {
                let nameField = document.querySelector(`[${foodNameIdKey}="${foodId}"]`);
                let proteinsField = document.querySelector(`[${foodProteinsIdKey}="${foodId}"]`);
                let fatsField = document.querySelector(`[${foodFatsIdKey}="${foodId}"]`);
                let carbsField = document.querySelector(`[${foodCarbsIdKey}="${foodId}"]`);
                let kcalField = document.querySelector(`[${foodKcalIdKey}="${foodId}"]`);
                let buttonField = document.querySelector(`[${foodButtonKey}="${foodId}"]`);

                let name = nameField.value.trim();
                let proteins = handleFloatField(proteinsField, 0, 100);
                let fats = handleFloatField(fatsField, 0, 100);
                let carbs = handleFloatField(carbsField, 0, 100);
                let kcal = handleNumberField(kcalField, 0, 999);

                let currFood = allFoods[foodId];
                let currName = currFood.name;
                let currProteins = currFood.proteins;
                let currFats = currFood.fats;
                let currCarbs = currFood.carbs;
                let currKcal = currFood.kcal;

                let allFieldsFilled = name.length && proteins != null && fats != null && carbs != null && kcal != null;
                if (!allFieldsFilled) {
                    buttonField.disabled = true;
                    return;
                }

                let anyFieldChanged = currName !== name
                    || currProteins !== proteins
                    || currFats !== fats
                    || currCarbs !== carbs
                    || currKcal !== kcal;

                buttonField.disabled = !anyFieldChanged;
            };

            for (let field of [foodNameIdKey, foodProteinsIdKey, foodFatsIdKey, foodCarbsIdKey, foodKcalIdKey]) {
                query(`[${field}]`, e => {
                    let value = e.getAttribute(field);
                    let foodId = parseInt(value);
                    if (Number.isNaN(foodId)) {
                        return;
                    }
                    onInput(e, () => checkEditButton(foodId));
                });
            }

            query(`[${foodButtonKey}]`, e => {
                let value = e.getAttribute(foodButtonKey);

                let foodId = parseInt(value);
                if (Number.isNaN(foodId)) {
                    return;
                }

                onClick(e, async () => {
                    let name = document.querySelector(`[${foodNameIdKey}="${foodId}"]`).value;
                    let proteins = document.querySelector(`[${foodProteinsIdKey}="${foodId}"]`).value;
                    let fats = document.querySelector(`[${foodFatsIdKey}="${foodId}"]`).value;
                    let carbs = document.querySelector(`[${foodCarbsIdKey}="${foodId}"]`).value;
                    let kcal = document.querySelector(`[${foodKcalIdKey}="${foodId}"]`).value;

                    let result = await _post("/api/food/edit", {
                        id: foodId,
                        name: name,
                        proteins: parseFloat(proteins),
                        fats: parseFloat(fats),
                        carbs: parseFloat(carbs),
                        kcal: parseInt(kcal),
                    });

                    if (result.id) {
                        allFoods[result.id] = result;
                    }

                    checkEditButton(foodId);
                });
            });

        };

        const renderDishes = () => {

            let search = byId(searchDishId).value.toLowerCase().trim();
            let searchTerms = search.split(/\s+/);

            let dishButtonKey = `data-ft-dish-btn-id`;
            let dishNameIdKey = `data-ft-dish-name-id`;
            let dishOutOfStockIdKey = `data-ft-dish-out-of-stock-id`;

            class Nutrients {
                constructor(proteins=0, fats=0, carbs=0, kcal=0) {
                    this.proteins = proteins;
                    this.fats = fats;
                    this.carbs = carbs;
                    this.kcal = kcal;
                }

                add(other) {
                    this.proteins += other.proteins;
                    this.fats += other.fats;
                    this.carbs += other.carbs;
                    this.kcal += other.kcal;
                    return this;
                }

                round() {
                    this.proteins = Math.round(this.proteins * 10) / 10;
                    this.fats = Math.round(this.fats * 10) / 10;
                    this.carbs = Math.round(this.carbs * 10) / 10;
                    this.kcal = Math.round(this.kcal);
                }
            }

            const calcNutrientsFromFood = (foodId, amount) => {
                let amount_per_100g = amount / 100;
                let food = allFoods[foodId];
                return new Nutrients(
                    food.proteins * amount_per_100g,
                    food.fats * amount_per_100g,
                    food.carbs * amount_per_100g,
                    food.kcal * amount_per_100g
                );
            };

            const calcNutrientsFromDish = (dish) => {
                let amount_per_100g = 1;
                let ingredients = Object.values(allDishIngredients).filter(e => e.dish_id === dish.id);
                let nutri = new Nutrients()
                if (ingredients.length === 0) {
                    return nutri;
                }
                let total_amount = 0;
                for (let i of ingredients) {
                    nutri.add(calcNutrientsFromFood(i.food_id, i.amount));
                    total_amount += i.amount;
                }
                let total_amount_per_100g = total_amount / 100;
                return new Nutrients(
                    nutri.proteins * amount_per_100g / total_amount_per_100g,
                    nutri.fats * amount_per_100g / total_amount_per_100g,
                    nutri.carbs * amount_per_100g / total_amount_per_100g,
                    nutri.kcal * amount_per_100g / total_amount_per_100g,
                );
            };

            const getDishHtml = (dish) => {
                let nutrients = calcNutrientsFromDish(dish);
                nutrients.round();

                return `
                <hr>
                <div class="">
                    <div class="d-flex align-items-start">
                        <div class="input-group mb-2-5 me-2">
                            <input ${dishNameIdKey}=${dish.id} type="text" class="form-control" value="${dish.name}">
                        </div>
                        ${HtmlPresets.switch('',  '', '', !dish.out_of_stock, true, 6, `${dishOutOfStockIdKey}=${dish.id}`)}
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="input-group">
                          <span class="input-group-text py-025 proteins-bg">Б</span>
                          <input type="text" class="form-control py-025 bg-white" value="${nutrients.proteins}" disabled>
                          <span class="input-group-text py-025 fats-bg">Ж</span>
                          <input type="text" class="form-control py-025 bg-white" value="${nutrients.fats}" disabled>
                          <span class="input-group-text py-025 carbs-bg">У</span>
                          <input type="text" class="form-control py-025 bg-white" value="${nutrients.carbs}" disabled>
                          <span class="input-group-text py-025 kcal-bg">Кк</span>
                          <input type="text" class="form-control py-025 bg-white" value="${nutrients.kcal}" disabled>
                        </div>
                        <button ${dishButtonKey}=${dish.id} class="btn btn-primary ms-2 py-025">Изменить</button>
                    </div>
                </div>
                `;
            };

            let dishesHtml = ``;

            for (let dish of Object.values(allDishes)) {
                let lowerCaseDishName = dish.name.toLowerCase();
                if (!searchTerms.every(term => lowerCaseDishName.includes(term))) {
                    continue;
                }
                dishesHtml = getDishHtml(dish) + dishesHtml;
            }

            byId(allDishesId).innerHTML = dishesHtml;

            const saveDish = async (dishId) => {
                let nameField = document.querySelector(`[${dishNameIdKey}="${dishId}"]`);
                let outOfStockField = document.querySelector(`[${dishOutOfStockIdKey}="${dishId}"]`);

                let name = nameField.value.trim();
                let outOfStock = !outOfStockField.checked;

                if (!name.length) {
                    return;
                }

                let result = await _post("/api/dish/edit", {
                    id: dishId,
                    name: name,
                    out_of_stock: outOfStock,
                });

                log(result)

                if (result.id) {
                    allDishes[result.id] = result;
                }
            };

            for (let field of [dishNameIdKey, dishOutOfStockIdKey]) {
                query(`[${field}]`, e => {
                    let value = e.getAttribute(field);
                    let dishId = parseInt(value);
                    if (Number.isNaN(dishId)) {
                        return;
                    }
                    if (field === dishNameIdKey) {
                        onInput(e, () => saveDish(dishId));
                    } else {
                        onChange(e, () => saveDish(dishId));
                    }
                });
            }

            query(`[${dishButtonKey}]`, e => {
                console.log(e)

                let value = e.getAttribute(dishButtonKey);
                let dishId = parseInt(value);
                if (Number.isNaN(dishId)) {
                    return;
                }

                onClick(e, () => {
                    hideElem(newDishTab);
                    showElem(editDishTab);
                    currentEditingDishId = dishId;
                    console.log(currentEditingDishId)
                    renderEditDish();
                });

            });

        };

        let currentEditingDishId = null;

        const deleteDishIngredientFromDishAsync = async (dishIngrId) => {
            let result = await _delete("/api/dish_ingredient/delete", {
                id: dishIngrId
            });
            if (result) {
                delete allDishIngredients[dishIngrId];
            }
            renderEditDish();
        };

        function deleteDishIngredientFromDish(dishIngrId) {
            deleteDishIngredientFromDishAsync(dishIngrId);
        }

        const renderEditDish = () => {
            let dishId = currentEditingDishId;

            let currDish = allDishes[dishId];

            console.log(dishId)
            console.log(currDish)

            byId(editDishNameId).value = currDish.name;
            byId(editDishOutOfStockId).checked = !currDish.out_of_stock;



            const renderDishIngr = (di) => {
                let name = allFoods[di.food_id].name;
                return `<div class='me-2 w-100 d-flex justify-content-between'>
                        <span>${name}</span>
                        <span>${di.amount} гр.</span>
                        </div>`
            };


            let options = ``;
            for (let food of Object.values(allFoods)) {
                options += `
                <option value="FOOD_${food.id}">${food.name}</option>
                `;
            }

            let dishIngredients = ``;
            for (let dishIngredient of Object.values(allDishIngredients)) {
                if (dishIngredient.dish_id !== dishId) {
                    continue;
                }

                dishIngredients = `
                ${
                   HtmlPresets.makeRow(`
                    ${renderDishIngr(dishIngredient)}
                    <button class="btn btn-sm btn-danger"
                        onclick="deleteDishIngredientFromDish(${dishIngredient.id})">Удалить</button>`,
                    {fs: 6, ps: 2})
                }
                ` + dishIngredients;
            }

            byId(editDishFoodListId).innerHTML = `

            <div class="row">
                <div class="col pe-0">

                    <div class="input-group input-group-sm h-100">
                        <select class="form-select" id="${editDishFoodListSelectId}">
                            <option value="" selected disabled></option>
                            ${options}
                        </select>
                        <input id="${editDishAmountInputId}" type="text"
                                class="form-control" placeholder="Кол-во" style="max-width: 4rem">
                        <span class="input-group-text">гр.</span>
                    </div>

                </div>
                <div class="col-auto">
                    <button id=${editDishAddNewBtnId} class="btn btn-primary">Добавить</button>
                </div>

                ${dishIngredients ? '<hr class="my-3">' : ''}
                <div>${dishIngredients}</div>

            </div>

            `;

            $(`#${editDishFoodListSelectId}`).select2({
                theme: 'bootstrap-5',
                placeholder: "Выбрать пищу",
                dropdownParent: $(`#${editFoodModal.modalId}`),
            });

            onInput(editDishAmountInputId, e => {
                handleNumberField(e, 0, 9999, true, null);
            });

            onClick(editDishAddNewBtnId, async e => {
                let foodId = null;

                let chosenMeal = byId(editDishFoodListSelectId).value;
                if (!chosenMeal) {
                    return;
                }

                if (chosenMeal.startsWith("FOOD_")) {
                    foodId = parseInt(chosenMeal.substring(5));
                }
                if (foodId == null) {
                    return;
                }

                let chosenAmount = handleNumberField(editDishAmountInputId, 0, 9999, true, null);
                if (chosenAmount == null) {
                    return;
                }

                let result = await _post("/api/dish_ingredient/new" ,{
                    food_id: foodId,
                    dish_id: dishId,
                    amount: chosenAmount,
                });

                if (result.id) {
                    allDishIngredients[result.id] = result;
                }

                renderEditDish();
            });

        };
    }


</script>
