
<div id="wrapper-edit-food-modal"></div>



<script>

    const editFoodModal = new Modal('edit-food', 'Редактировать еду', true, true, false);
    editFoodModal.cancelButton.innerText = "Назад";

    {
        const rootId = editFoodModal.modalId;

        const addFoodNameId = `${rootId}-add-food-name`;
        const addProteinsId = `${rootId}-add-food-proteins`;
        const addFatsId = `${rootId}-add-food-fats`;
        const addCarbsId = `${rootId}-add-food-carbs`;
        const addKcalId = `${rootId}-add-food-kcal`;
        const addFoodPortionSizeId = `${rootId}-add-food-addFoodPortionSizeId`;
        const addFoodIngredientOnlyId = `${rootId}-add-food-addFoodIngredientOnlyId`;
        const addFoodButtonId = `${rootId}-add-food-button`;

        const addSearchDishNameId = `${rootId}-addSearchDishNameId`;
        const dishSearchIconDiv = `${rootId}-dishSearchIconDiv`;
        const dishSearchLimitedEntries = `${rootId}-dishSearchLimitedEntries`;
        const dishSearchAllEntries = `${rootId}-dishSearchAllEntries`;
        const editDishNameId = `${rootId}-editDishNameId`;
        const editDishForDishNameId = `${rootId}-editDishForDishNameId`;
        const editDishFoodListId = `${rootId}-editDishFoodListId`;
        const editDishRecipeInputId = `${rootId}-editDishRecipeInputId`;
        const editDishFoodListSelectId = `${rootId}-editDishFoodListSelectId`;
        const editDishOutOfStockId = `${rootId}-editDishOutOfStockId`;
        const editDishAddNewBtnId = `${rootId}-editDishAddNewBtnId`;
        const editDishAmountInputId = `${rootId}-editDishAmountInputId`;
        const editDishGetBackId = `${rootId}-editDishGetBackId`;
        const editDishAddRecipeNameInputId = `${rootId}-editDishAddRecipeNameInputId`;
        const editDishAddRecipeBtnId = `${rootId}-editDishAddRecipeBtnId`;
        const editDishAllDishRecipesId = `${rootId}-editDishAllDishRecipesId`;
        const addDishButtonId = `${rootId}-addDishButtonId`;
        const editDishEditButtonsId = `${rootId}-editDishEditButtonsId`;
        const editDishEditSettingsId = `${rootId}-editDishEditSettingsId`;
        const editDishEditParentId = `${rootId}-editDishEditParentId`;
        const editDishEditParentSelectId = `${rootId}-editDishEditParentSelectId`;
        const editDishEditParentConfirmId = `${rootId}-editDishEditParentConfirmId`;

        const dishButtonKey = `data-ft-dish-btn-id`;
        const dishNameIdKey = `data-ft-dish-name-id`;
        const dishOutOfStockIdKey = `data-ft-dish-out-of-stock-id`;

        const searchFoodId = `${rootId}-searchFoodId`;
        const allFoodsId = `${rootId}-allFoodsId`;

        const allDishesId = `${rootId}-allDishesId`;

        const foodTabButtonId = `${rootId}-foodTabButtonId`;
        const dishTabButtonId = `${rootId}-dishTabButtonId`;
        const foodTabId = `${rootId}-foodTabId`;
        const dishTabId = `${rootId}-dishTabId`;

        const foodSearchTabButtonId = `${rootId}-foodSearchTabButtonId`;
        const foodSearchIconDiv = `${rootId}-foodSearchIconDiv`;
        const foodSearchLimitedEntries = `${rootId}-foodSearchLimitedEntries`;
        const foodSearchAllEntries = `${rootId}-foodSearchAllEntries`;
        const foodAddTabButtonId = `${rootId}-foodAddTabButtonId`;
        const foodDeleteTabButtonId = `${rootId}-foodDeleteTabButtonId`;
        const foodSearchTabRadioId = `${rootId}-foodSearchTabRadioId`;
        const foodAddTabRadioId = `${rootId}-foodAddTabRadioId`;
        const foodDeleteTabRadioId = `${rootId}-foodDeleteTabRadioId`;
        const foodAddSectionId = `${rootId}-foodAddSectionId`;

        const newDishTab = `${rootId}-newDishTab`;
        const editDishTab = `${rootId}-editDishTab`;

        editFoodModal.onClose(() => {
            startEditMealGroup(currEditingMealGroup);
            searchFoodMode = true;
            addingFoodMode = false;
            deletingFoodMode = false;
            searchAllFoodMode = false;
            searchAllDishesMode = false;
            editFoodModal.titleMoveButton.disabled = false;
            editFoodModal.titleCopyButton.disabled = false;
        });

        onClick(editFoodModal.titleMoveButton, () => {
            moveDishIngredientsToDish();
        });

        onClick(editFoodModal.titleCopyButton, () => {
            copyDishIngredientsToDish();
        });

        onClick(editFoodModal.titleDeleteButton, () => {
            deleteDishIngredientsFromDish();
        });

        const moveDishIngredientsToDish = async () => {
            if (currentEditingDishId == null) {
                return;
            }

            let items = getSelectedItems(SelectionType.DISH_INGREDIENT);
            if (items.length === 0) {
                return;
            }

            let result = await _post("/api/dish_ingredient/move", {
                move_to_dish: currentEditingDishId,
                dish_ingredient_ids: items
            });

            if (result) {
                for (let di of result) {
                    allDishIngredients[di.id] = di;
                }
            }

            clearSelection(SelectionType.DISH_INGREDIENT);
            editFoodModal.setupTitle(SelectionType.DISH_INGREDIENT);

            renderEditDish();
        }

        const copyDishIngredientsToDish = async () => {
            if (currentEditingDishId == null) {
                return;
            }

            let items = getSelectedItems(SelectionType.DISH_INGREDIENT);
            if (items.length === 0) {
                return;
            }

            let result = await _post("/api/dish_ingredient/duplicate", {
                move_to_dish: currentEditingDishId,
                dish_ingredient_ids: items
            });

            if (result) {
                for (let di of result) {
                    allDishIngredients[di.id] = di;
                }
            }

            clearSelection(SelectionType.DISH_INGREDIENT);
            editFoodModal.setupTitle(SelectionType.DISH_INGREDIENT);

            renderEditDish();
        }

        const deleteDishIngredientsFromDish = async () => {
            if (currentEditingDishId == null) {
                return;
            }

            let items = getSelectedItems(SelectionType.DISH_INGREDIENT);
            if (items.length === 0) {
                return;
            }

            let result = await _delete("/api/dish_ingredient/delete_many", {
                dish_ingredient_ids: items
            });

            if (result) {
                for (let diId of result) {
                    delete allDishIngredients[diId];
                }
            }

            clearSelection(SelectionType.DISH_INGREDIENT);
            editFoodModal.setupTitle(SelectionType.DISH_INGREDIENT);

            renderEditDish();
        }

        let searchFoodMode = true;
        let addingFoodMode = false;
        let deletingFoodMode = false;
        let searchAllFoodMode = false;
        let searchAllDishesMode = false;

        editFoodModal.onOpen(() => {

            editFoodModal.setHtml(`
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
                <label id=${foodTabButtonId}  class="btn btn-outline-primary w-50 py-05" for="btnradio1">Еда</label>

                <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
                <label id=${dishTabButtonId} class="btn btn-outline-primary w-50 py-05" for="btnradio2">Блюдо</label>
            </div>

            <div id="${foodTabId}">

                <hr>

                <div class="btn-group fs-4 w-100 mb-3">
                    <input type="radio" class="btn-check" name="btnfoodsearch" id="${foodSearchTabRadioId}" autocomplete="off" checked>
                    <label id=${foodSearchTabButtonId}  class="btn btn-outline-primary w-50 py-05" for="${foodSearchTabRadioId}">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </label>

                    <input type="radio" class="btn-check" name="btnfoodsearch" id="${foodAddTabRadioId}" autocomplete="off">
                    <label id=${foodAddTabButtonId} class="btn btn-outline-primary w-50 py-05" for="${foodAddTabRadioId}">
                        <i class="fa-solid fa-plus"></i>
                    </label>

                    <input type="radio" class="btn-check" name="btnfoodsearch" id="${foodDeleteTabRadioId}" autocomplete="off">
                    <label id=${foodDeleteTabButtonId} class="btn btn-outline-primary w-50 py-05" for="${foodDeleteTabRadioId}">
                        <i class="fa-solid fa-trash"></i>
                    </label>
                </div>

                <div id="${foodAddSectionId}" class="d-none add-highlight">
                    <div class="opacity-50" >Новая еда</div>

                    <div class="input-group mb-2">
                         <input id="${addFoodNameId}" type="text" class="form-control" placeholder="Название">
                         <span class="input-group-text py-025">1шт</span>
                         <input id="${addFoodPortionSizeId}" type="text" class="form-control portion-input text-center" placeholder="Вес">
                    </div>

                    <div class="mb-2">
                        ${HtmlPresets.switch(addFoodIngredientOnlyId, '', 'Для блюд', false, true, 6)}
                    </div>

                    <div class="d-flex">
                        <div class="input-group">
                          <span class="input-group-text py-025 proteins-bg">Б</span>
                          <input id="${addProteinsId}" type="text" class="form-control py-025" placeholder="0">
                          <span class="input-group-text py-025 fats-bg">Ж</span>
                          <input id="${addFatsId}" type="text" class="form-control py-025" placeholder="0">
                          <span class="input-group-text py-025 carbs-bg">У</span>
                          <input id="${addCarbsId}" type="text" class="form-control py-025" placeholder="0">
                          <span class="input-group-text py-025 kcal-bg">Кк</span>
                          <input id="${addKcalId}" type="text" class="form-control py-025" placeholder="0">
                        </div>
                        <button id="${addFoodButtonId}" class="btn btn-primary ms-2 py-025" disabled>Добавить</button>
                    </div>

                    <hr>
                </div>



                <div class="opacity-50" >Добавленная еда</div>

                <div class="input-group mb-3">
                  <span id=${foodSearchIconDiv} class="input-group-text">
                      <i id=${foodSearchLimitedEntries} class="fa-solid fa-magnifying-glass"></i>
                      <i id=${foodSearchAllEntries} class="fa-solid fa-earth-americas text-white"></i>
                  </span>
                  <input id="${searchFoodId}" type="text" class="form-control" placeholder="Искать по названию">
                </div>

                <div id="${allFoodsId}"></div>
            </div>

            <div id="${dishTabId}" class="d-none">
                <hr>

                <div id=${newDishTab}>
                    <div class="opacity-50" >Новое блюдо</div>
                    <div class="d-flex">
                        <div class="input-group">
                            <span id=${dishSearchIconDiv} class="input-group-text">
                               <i id=${dishSearchLimitedEntries} class="fa-solid fa-magnifying-glass"></i>
                               <i id=${dishSearchAllEntries} class="fa-solid fa-earth-americas text-white"></i>
                            </span>
                            <input id="${addSearchDishNameId}" type="text" class="form-control" placeholder="Название">
                        </div>
                        <button id="${addDishButtonId}" class="btn btn-primary ms-2 py-025" disabled>Добавить</button>
                    </div>

                    <hr>

                    <div class="opacity-50" style="margin-bottom: -1rem;" >Добавленные блюда</div>

                    <div id="${allDishesId}"></div>

                </div>
                <div id=${editDishTab} class="d-none">

                    <div class="d-flex justify-content-between align-items-start">
                        <div class="opacity-50" >Редактировать блюдо</div>
                        <h6 id="${editDishGetBackId}" class="subtle-link" style="margin-top: -0.5rem;margin-right: 0.5rem;">
                            Вернуться
                            <i class="fa-solid fa-arrow-right"></i>
                        </h6>
                    </div>

                    <div id=${editDishFoodListId}></div>

                </div>




            </div>
            `);

            onClick(foodTabButtonId, () => {
                showElem(foodTabId);
                hideElem(dishTabId);
            });

            onClick(dishTabButtonId, () => {
                hideElem(foodTabId);
                showElem(dishTabId);
            });

            onClick(editDishGetBackId, e => {
                let currDish = allDishes[currentEditingDishId];
                if (currDish.for_dish === null) {
                    currentEditingDishId = null;
                    showElem(newDishTab);
                    hideElem(editDishTab);
                    renderDishes();
                } else {
                    currentEditingDishId = currDish.for_dish;
                    renderEditDish();
                }
            });

            const _checkFoodTabVisibility = () => {
                if (addingFoodMode) {
                    showElem(foodAddSectionId);
                } else {
                    hideElem(foodAddSectionId);
                }
            };

            onClick(foodSearchTabButtonId, () => {
                searchFoodMode = true;
                addingFoodMode = false;
                deletingFoodMode = false;
                _checkFoodTabVisibility();
                renderFoods();
            });

            onClick(foodAddTabButtonId, () => {
                searchFoodMode = false;
                addingFoodMode = true;
                deletingFoodMode = false;
                _checkFoodTabVisibility();
                renderFoods();
            });

            onClick(foodDeleteTabButtonId, () => {
                searchFoodMode = false;
                addingFoodMode = false;
                deletingFoodMode = true;
                _checkFoodTabVisibility();
                renderFoods();
            });

            onClick(foodSearchIconDiv, () => {
                searchAllFoodMode = !searchAllFoodMode;
                renderFoods();
            });

            onClick(dishSearchIconDiv, () => {
                searchAllDishesMode = !searchAllDishesMode;
                renderDishes();
            });


            onInput(searchFoodId, renderFoods);
            onInput(addSearchDishNameId, renderDishes);
            renderFoods();
            renderDishes();


            const calcCalories = (proteins, fats, carbs) => {
                return Math.round(proteins * 4 + fats * 9 + carbs * 4);
            };


            const checkAddFoodButton = autoCalcKcal => {
                let name = byId(addFoodNameId).value.trim();
                let proteins = handleFloatField(addProteinsId, 0, 100, true);
                let fats = handleFloatField(addFatsId, 0, 100, true);
                let carbs = handleFloatField(addCarbsId, 0, 100, true);

                let kcal;
                if (autoCalcKcal && proteins != null && fats != null && carbs != null) {
                    let calculatedKcal = calcCalories(proteins, fats, carbs);
                    byId(addKcalId).value = calculatedKcal + '';
                    kcal = handleNumberField(addKcalId, calculatedKcal, calculatedKcal);
                } else {
                    kcal = handleNumberField(addKcalId, 0, 999);
                }

                handleNumberField(addFoodPortionSizeId, 0, 9999);

                byId(addFoodButtonId).disabled =
                    !(name.length && proteins != null && fats != null && carbs != null && kcal != null);
            };

            let fields = [
                addFoodNameId,
                addProteinsId,
                addFatsId,
                addCarbsId,
                addKcalId,
                addFoodPortionSizeId,
                addFoodIngredientOnlyId,
            ];

            let autoCalcKcalOnFields = [
                addProteinsId,
                addFatsId,
                addCarbsId,
            ];

            for (let field of fields) {
                let autoCalcKcal = autoCalcKcalOnFields.includes(field);
                onInput(field, () => checkAddFoodButton(autoCalcKcal));
            }

            onClick(addFoodButtonId, async () => {
                let name = byId(addFoodNameId).value.trim();
                let proteins = handleFloatField(addProteinsId, 0, 100, true);
                let fats = handleFloatField(addFatsId, 0, 100, true);
                let carbs = handleFloatField(addCarbsId, 0, 100, true);
                let kcal = handleNumberField(addKcalId, 0, 999);
                let portion = handleNumberField(addFoodPortionSizeId, 0, 9999);
                let ingredientOnly = byId(addFoodIngredientOnlyId).checked;

                byId(addFoodButtonId).disabled = true;

                let result = await _post("/api/food/new" ,{
                    name: name,
                    proteins: proteins,
                    fats: fats,
                    carbs: carbs,
                    kcal: kcal,
                    portion_size: portion,
                    ingredient_only: ingredientOnly,
                });

                if (result.id) {
                    allFoods[result.id] = result;
                }

                for (let field of fields) {
                    byId(field).value = "";
                }

                renderFoods();
                renderEditDish();
            });

            const checkAddDishButton = () => {
                let name = byId(addSearchDishNameId).value.trim();
                byId(addDishButtonId).disabled = !(name.length);
            };

            for (let field of [addSearchDishNameId]) {
                onInput(field, checkAddDishButton);
            }

            onClick(addDishButtonId, async () => {
                let name = byId(addSearchDishNameId).value.trim();

                byId(addDishButtonId).disabled = true;

                let result = await _post("/api/dish/new" ,{
                    name: name,
                    for_dish: null,
                    out_of_stock: false,
                });

                if (result.id) {
                    allDishes[result.id] = result;
                }

                for (let field of [addSearchDishNameId]) {
                    byId(field).value = "";
                }

                renderDishes();
            });
        });

        const renderFoodSearchIcon = () => {
            _renderSearchIcon(searchAllFoodMode, foodSearchIconDiv, foodSearchAllEntries, foodSearchLimitedEntries);
        };

        const renderDishSearchIcon = () => {
            _renderSearchIcon(searchAllDishesMode, dishSearchIconDiv, dishSearchAllEntries, dishSearchLimitedEntries);
        };

        const _renderSearchIcon = (mode, divId, allId, limitedId) => {
            let iconDiv = byId(divId);
            let allIcon = byId(allId);
            let limitedIcon = byId(limitedId);
            if (mode) {
                iconDiv.classList.add('bg-primary');
                showElem(allIcon);
                hideElem(limitedIcon);
            } else {
                iconDiv.classList.remove('bg-primary');
                showElem(limitedIcon);
                hideElem(allIcon);
            }
        };

        const renderFoods = () => {
            renderFoodSearchIcon();

            let search = byId(searchFoodId).value.toLowerCase().trim();

            let foodButtonKey = `data-ft-food-btn-id`;
            let foodReviveButtonKey = `data-ft-food-foodReviveButtonKey`;
            let foodDeleteButtonKey = `data-ft-food-foodDeleteButtonKey`;
            let foodNameIdKey = `data-ft-food-name-id`;
            let foodPortionSizeIdKey = `data-ft-food-foodPortionSizeIdKey-id`;
            let foodIngredientOnlyIdKey = `data-ft-food-foodIngredientOnlyIdKey-id`;
            let foodProteinsIdKey = `data-ft-food-proteins-id`;
            let foodFatsIdKey = `data-ft-food-fats-id`;
            let foodCarbsIdKey = `data-ft-food-carbs-id`;
            let foodKcalIdKey = `data-ft-food-kcal-id`;

            let foodsHtml = ``;
            let foodsCount = 0;
            for (let food of SearchFilter.search(Object.values(allFoods), f => f.name, search, true)) {
                if (food.is_deleted && !addingFoodMode) {
                    continue;
                }

                foodsCount++;
                if (foodsCount > MAX_ENTRIES_IN_LIST && !searchAllFoodMode) {
                    break;
                }

                let editable = deletingFoodMode || food.is_deleted ? 'disabled' : '';

                foodsHtml += `
                <hr>
                <div class="${food.is_deleted ? 'deleted-highlight' : ''}">
                    <div class="input-group mb-2">
                        <input ${foodNameIdKey}=${food.id} type="text" class="form-control" value="${food.name.replace(/"/g, '&quot;')}" ${editable}>
                        <span class="input-group-text py-025">1шт</span>
                        <input ${foodPortionSizeIdKey}=${food.id} type="text" class="form-control portion-input text-center"
                                placeholder="Вес" value="${food.portion_size ?? ''}" ${editable}>
                    </div>
                    <div class="mb-2">
                        ${HtmlPresets.switch(generateUUID(), '', 'Для блюд', food.ingredient_only, true, 6, `${foodIngredientOnlyIdKey}=${food.id}`)}
                    </div>
                    <div class="d-flex">
                        <div class="input-group">
                          <span class="input-group-text py-025 proteins-bg">Б</span>
                          <input ${foodProteinsIdKey}=${food.id} type="text" class="form-control py-025" value="${food.proteins}" ${editable}>
                          <span class="input-group-text py-025 fats-bg">Ж</span>
                          <input ${foodFatsIdKey}=${food.id} type="text" class="form-control py-025" value="${food.fats}" ${editable}>
                          <span class="input-group-text py-025 carbs-bg">У</span>
                          <input ${foodCarbsIdKey}=${food.id} type="text" class="form-control py-025" value="${food.carbs}" ${editable}>
                          <span class="input-group-text py-025 kcal-bg">Кк</span>
                          <input ${foodKcalIdKey}=${food.id} type="text" class="form-control py-025" value="${food.kcal}" ${editable}>
                        </div>
                        <button ${foodButtonKey}=${food.id} class="btn btn-primary ms-2 py-025 ${!deletingFoodMode && !food.is_deleted ? '' : 'd-none'}" disabled>Изменить</button>
                        <button ${foodReviveButtonKey}=${food.id} class="btn btn-success opacity-65 ms-2 py-025 ${!deletingFoodMode && food.is_deleted ? '' : 'd-none'}">Вернуть</button>
                        <button ${foodDeleteButtonKey}=${food.id} class="btn btn-danger ms-2 py-025 ${deletingFoodMode ? '' : 'd-none'}">Удалить</button>
                    </div>
                </div>

                `;
            }

            byId(allFoodsId).innerHTML = foodsHtml;

            const checkEditButton = (foodId) => {
                let nameField = document.querySelector(`[${foodNameIdKey}="${foodId}"]`);
                let proteinsField = document.querySelector(`[${foodProteinsIdKey}="${foodId}"]`);
                let fatsField = document.querySelector(`[${foodFatsIdKey}="${foodId}"]`);
                let carbsField = document.querySelector(`[${foodCarbsIdKey}="${foodId}"]`);
                let kcalField = document.querySelector(`[${foodKcalIdKey}="${foodId}"]`);
                let portionSizeField = document.querySelector(`[${foodPortionSizeIdKey}="${foodId}"]`);
                let ingredientOnlyField = document.querySelector(`[${foodIngredientOnlyIdKey}="${foodId}"]`);
                let buttonField = document.querySelector(`[${foodButtonKey}="${foodId}"]`);

                let name = nameField.value.trim();
                let proteins = handleFloatField(proteinsField, 0, 100, true);
                let fats = handleFloatField(fatsField, 0, 100, true);
                let carbs = handleFloatField(carbsField, 0, 100, true);
                let kcal = handleNumberField(kcalField, 0, 999);
                let portionSize = handleNumberField(portionSizeField, 0, 9999);
                let ingredientOnly = ingredientOnlyField.checked;

                let currFood = allFoods[foodId];
                let currName = currFood.name;
                let currProteins = currFood.proteins;
                let currFats = currFood.fats;
                let currCarbs = currFood.carbs;
                let currKcal = currFood.kcal;
                let currPortionSize = currFood.portion_size;
                let currIngredientOnly = currFood.ingredient_only;

                let allFieldsFilled = name.length && proteins != null && fats != null && carbs != null && kcal != null;
                if (!allFieldsFilled) {
                    buttonField.disabled = true;
                    return;
                }

                let anyFieldChanged = currName !== name
                    || currProteins !== proteins
                    || currFats !== fats
                    || currCarbs !== carbs
                    || currKcal !== kcal
                    || currPortionSize !== portionSize
                    || currIngredientOnly !== ingredientOnly
                    ;

                buttonField.disabled = !anyFieldChanged;
            };

            for (let field of [foodNameIdKey, foodProteinsIdKey,
                                foodFatsIdKey, foodCarbsIdKey,
                                foodKcalIdKey, foodPortionSizeIdKey,
                                foodIngredientOnlyIdKey]) {
                query(`[${field}]`, e => {
                    let value = e.getAttribute(field);
                    let foodId = parseInt(value);
                    if (Number.isNaN(foodId)) {
                        return;
                    }
                    onInput(e, () => checkEditButton(foodId));
                });
            }

            query(`[${foodButtonKey}]`, e => {
                let value = e.getAttribute(foodButtonKey);

                let foodId = parseInt(value);
                if (Number.isNaN(foodId)) {
                    return;
                }

                onClick(e, async () => {
                    let name = document.querySelector(`[${foodNameIdKey}="${foodId}"]`).value.trim();
                    document.querySelector(`[${foodNameIdKey}="${foodId}"]`).value = name;

                    let proteins = document.querySelector(`[${foodProteinsIdKey}="${foodId}"]`).value;
                    let fats = document.querySelector(`[${foodFatsIdKey}="${foodId}"]`).value;
                    let carbs = document.querySelector(`[${foodCarbsIdKey}="${foodId}"]`).value;
                    let kcal = document.querySelector(`[${foodKcalIdKey}="${foodId}"]`).value;
                    let portionSize = document.querySelector(`[${foodPortionSizeIdKey}="${foodId}"]`).value;
                    let ingredientOnly = document.querySelector(`[${foodIngredientOnlyIdKey}="${foodId}"]`).checked;

                    let result = await _post("/api/food/edit", {
                        id: foodId,
                        name: name,
                        proteins: parseFloat(proteins),
                        fats: parseFloat(fats),
                        carbs: parseFloat(carbs),
                        kcal: parseInt(kcal),
                        portion_size: parseInt(portionSize),
                        ingredient_only: ingredientOnly,
                    });

                    if (result.id) {
                        allFoods[result.id] = result;
                    }

                    checkEditButton(foodId);
                });
            });

            query(`[${foodDeleteButtonKey}]`, e => {
                let value = e.getAttribute(foodDeleteButtonKey);

                let foodId = parseInt(value);
                if (Number.isNaN(foodId)) {
                    return;
                }

                onClick(e, async () => {
                    let result = await _delete("/api/food/delete", {
                        id: foodId,
                    });

                    if (result.id) {
                        allFoods[result.id] = result;
                    }

                    renderFoods();
                });
            });

            query(`[${foodReviveButtonKey}]`, e => {
                let value = e.getAttribute(foodReviveButtonKey);

                let foodId = parseInt(value);
                if (Number.isNaN(foodId)) {
                    return;
                }

                onClick(e, async () => {
                    let result = await _post("/api/food/revive", {
                        id: foodId,
                    });

                    if (result.id) {
                        allFoods[result.id] = result;
                    }

                    renderFoods();
                });
            });

        };

        class Nutrients {
            constructor(proteins=0, fats=0, carbs=0, kcal=0) {
                this.proteins = proteins;
                this.fats = fats;
                this.carbs = carbs;
                this.kcal = kcal;
            }

            add(other) {
                this.proteins += other.proteins;
                this.fats += other.fats;
                this.carbs += other.carbs;
                this.kcal += other.kcal;
                return this;
            }

            round() {
                this.proteins = Math.round(this.proteins * 10) / 10;
                this.fats = Math.round(this.fats * 10) / 10;
                this.carbs = Math.round(this.carbs * 10) / 10;
                this.kcal = Math.round(this.kcal);
            }
        }

        const calcNutrientsFromFood = (foodId, amount) => {
            let amount_per_100g = amount / 100;
            let food = allFoods[foodId];
            return new Nutrients(
                food.proteins * amount_per_100g,
                food.fats * amount_per_100g,
                food.carbs * amount_per_100g,
                food.kcal * amount_per_100g
            );
        };

        const calcNutrientsFromDish = (dishId, amount=100) => {
            let dish = allDishes[dishId];

            let amount_per_100g = amount / 100;
            let ingredients = Object.values(allDishIngredients).filter(e => e.dish_id === dish.id);
            let nutri = new Nutrients()
            if (ingredients.length === 0) {
                return nutri;
            }
            let total_amount = 0;
            for (let i of ingredients) {
                if (i.food_id_ingredient) {
                    nutri.add(calcNutrientsFromFood(i.food_id_ingredient, i.amount));
                    total_amount += i.amount;
                } else if (i.dish_id_ingredient) {
                    nutri.add(calcNutrientsFromDish(i.dish_id_ingredient, i.amount));
                    total_amount += i.amount;
                }
            }
            let total_amount_per_100g = total_amount / 100;
            return new Nutrients(
                nutri.proteins * amount_per_100g / total_amount_per_100g,
                nutri.fats * amount_per_100g / total_amount_per_100g,
                nutri.carbs * amount_per_100g / total_amount_per_100g,
                nutri.kcal * amount_per_100g / total_amount_per_100g,
            );
        };

        const calcDishTotalWeight = (dishId) => {
            let dish = allDishes[dishId];

            let totalWeight = 0;
            let ingredients = Object.values(allDishIngredients).filter(e => e.dish_id === dish.id);
            for (let i of ingredients) {
                totalWeight += i.amount;
            }

            return totalWeight;
        };

        const saveDish = async (dishId) => {
            let nameField = document.querySelector(`[${dishNameIdKey}="${dishId}"]`);
            let outOfStockField = document.querySelector(`[${dishOutOfStockIdKey}="${dishId}"]`);

            let name = '';
            if (nameField.value !== undefined) {
                name = nameField.value.trim();
            } else {
                name = allDishes[dishId].name.trim();
            }
            let outOfStock = !outOfStockField.checked;

            if (!name.length) {
                return;
            }

            let result = await _post("/api/dish/edit", {
                id: dishId,
                name: name,
                out_of_stock: outOfStock,
            });

            if (result.id) {
                allDishes[result.id] = result;
            }
        };

        const getDishHtml = (dish, nameEditable=true) => {
            let nutrients = calcNutrientsFromDish(dish.id);
            nutrients.round();

            return `
            <hr>
            <div class="">
                <div class="d-flex align-items-start">
                    <div class="input-group mb-2-5 me-2">
                        ${
                            nameEditable ? `
                            <input ${dishNameIdKey}=${dish.id} type="text" class="form-control" value="${dish.name.replace(/"/g, '&quot;')}">
                            ` : `
                            <div ${dishNameIdKey}=${dish.id} class="form-control div-hover">${getDishFullName(dish.id)}</div>
                            `
                        }

                    </div>
                    ${HtmlPresets.switch('',  '', '', !dish.out_of_stock, true, 6, `${dishOutOfStockIdKey}=${dish.id}`)}
                </div>
                <div class="d-flex justify-content-end">
                    <div class="input-group">
                      <span class="input-group-text py-025 proteins-bg">Б</span>
                      <input type="text" class="form-control py-025 bg-white" value="${nutrients.proteins}" disabled>
                      <span class="input-group-text py-025 fats-bg">Ж</span>
                      <input type="text" class="form-control py-025 bg-white" value="${nutrients.fats}" disabled>
                      <span class="input-group-text py-025 carbs-bg">У</span>
                      <input type="text" class="form-control py-025 bg-white" value="${nutrients.carbs}" disabled>
                      <span class="input-group-text py-025 kcal-bg">Кк</span>
                      <input type="text" class="form-control py-025 bg-white" value="${nutrients.kcal}" disabled>
                    </div>
                    <button ${dishButtonKey}=${dish.id} class="btn btn-primary ms-2 py-025">Изменить</button>
                </div>
            </div>
            `;
        };

        const setDishesCallbacks = (nameCallback=null) => {
            for (let field of [dishNameIdKey, dishOutOfStockIdKey]) {
                query(`[${field}]`, e => {
                    let value = e.getAttribute(field);
                    let dishId = parseInt(value);
                    if (Number.isNaN(dishId)) {
                        return;
                    }

                    let okField = field + "-OK";
                    if (e.getAttribute(okField) !== null) {
                        return;
                    } else {
                        e.setAttribute(okField, "OK");
                    }

                    if (field === dishNameIdKey) {
                        if (nameCallback == null) {
                            onInput(e, () => saveDish(dishId));
                        } else {
                            onClick(e, () => nameCallback(dishId));
                        }

                    } else if (field === dishOutOfStockIdKey) {
                        onChange(e, () => saveDish(dishId));
                    }
                });
            }

            query(`[${dishButtonKey}]`, e => {

                let value = e.getAttribute(dishButtonKey);
                let dishId = parseInt(value);
                if (Number.isNaN(dishId)) {
                    return;
                }

                let okField = dishButtonKey + "-ok";
                if (e.getAttribute(okField) !== null) {
                    return;
                } else {
                    e.setAttribute(okField, "OK");
                }

                onClick(e, () => {
                    byId(addSearchDishNameId).value = "";
                    hideElem(newDishTab);
                    showElem(editDishTab);

                    currentEditingDishId = dishId;

                    renderEditDish();

                    byId(editFoodModal.bodyId).scrollTop = 0;
                });
            });
        };

        const renderDishes = () => {
            editFoodModal.setupTitle();

            renderDishSearchIcon();

            let search = byId(addSearchDishNameId).value;

            const setAllDishesHtml = () => {
                let dishesHtml = ``;

                /**
                 * @type {Dish[]}
                 */
                let sortedDishes = [];
                for (let d of Object.values(allDishes)) {
                    if (d.out_of_stock) {
                        sortedDishes.push(d);
                    }
                }
                for (let d of Object.values(allDishes)) {
                    if (!d.out_of_stock) {
                        sortedDishes.push(d);
                    }
                }

                let dishesCount = 0;
                for (let dish of SearchFilter.search(Object.values(sortedDishes), d => d.name, search, true)) {
                    if (dish.for_dish !== null) {
                        continue;
                    }

                    dishesCount++;
                    if (dishesCount > MAX_ENTRIES_IN_LIST && dish.out_of_stock && !searchAllDishesMode) {
                        break;
                    }

                    dishesHtml += getDishHtml(dish);
                }

                byId(allDishesId).innerHTML = dishesHtml;
            };

            setAllDishesHtml();
            setDishesCallbacks();
        };

        let currentEditingDishId = null;

        const deleteDishIngredientFromDishAsync = async (dishIngrId) => {
            let result = await _delete("/api/dish_ingredient/delete", {
                id: dishIngrId
            });
            if (result) {
                delete allDishIngredients[dishIngrId];
            }
            renderEditDish();
        };

        function deleteDishIngredientFromDish(dishIngrId) {
            deleteDishIngredientFromDishAsync(dishIngrId);
        }

        const renderEditDish = () => {
            if (currentEditingDishId === null) {
                return;
            }

            editFoodModal.titleMoveButton.disabled = false;
            editFoodModal.titleCopyButton.disabled = false;

            let dishId = currentEditingDishId;

            let currDish = allDishes[dishId];

            console.log(dishId)
            console.log(currDish)


            const renderDishIngr = (di) => {
                let name;
                if (di.food_id_ingredient) {
                    name = allFoods[di.food_id_ingredient].name;
                } else {
                    name = getDishFullName(di.dish_id_ingredient);
                }
                return `
                <div class='me-2 w-100 d-flex justify-content-between align-items-center'>
                    <span>${name}</span>
                    <span>${di.amount}&nbsp;гр.</span>
                </div>`
            };



            let options = '';
            let elems = getItemsList({
                dishFilter: (dish, dishParents) => {
                    if (dishParents.includes(dish.id)) {
                        return false;
                    }
                    return !dish.out_of_stock || dishParents.includes(dish.for_dish);
                }
            });

            // Build the options string
            for (let elem of elems) {
                options += `
                <option value="${elem.type}_${elem.id}">${elem.name}</option>
                `;
            }

            /**
             * @param {DishIngredient} di
             */
            const autoSelectDishIngredient = (di) => {
                let val = '';
                if (di.dish_id_ingredient) {
                    val = `DISH_${di.dish_id_ingredient}`;
                } else if (di.food_id_ingredient) {
                    val = `FOOD_${di.food_id_ingredient}`;
                }
                $(`#${editDishFoodListSelectId}`).val(val).trigger('change');
            };

            /**
             * @param {Dish} dish
             */
            const autoSelectDish = (dish) => {
                 let val = `DISH_${dish.id}`;
                 $(`#${editDishFoodListSelectId}`).val(val).trigger('change');
            };


            let totalWeight = 0;

            let dishIngredients = ``;
            let position = 0;
            let currDishIngredients = Object.values(allDishIngredients).filter(e => e.dish_id === dishId);

            for (let dishIngredient of currDishIngredients) {
                position++;

                let di = dishIngredient;
                totalWeight += di.amount;

                let ingrId = di.dish_id_ingredient
                    ? `INGREDIENT_DISH_${di.dish_id_ingredient}-${position}`
                    : `INGREDIENT_FOOD_${di.food_id_ingredient}-${position}`;
                let innerId = ingrId + "-inner";

                setTimeout(() => {
                    let obj = byId(ingrId);

                    let longPressed = false;

                    onClick(obj, () => {
                        if (longPressed) {
                            longPressed = false;
                            return;
                        }
                        if (isSelectionActive(SelectionType.DISH_INGREDIENT)) {
                            selectItem(SelectionType.DISH_INGREDIENT, di.id);
                            setupSelection();
                        } else {
                            autoSelectDishIngredient(di);
                        }
                    });

                    setupLongPress(obj, () => {
                        longPressed = true;
                        selectItem(SelectionType.DISH_INGREDIENT, di.id);
                        setupSelection();
                    });

                    const setupSelection = () => {
                        if (isItemSelected(SelectionType.DISH_INGREDIENT, di.id)) {
                            byId(innerId).classList.add('user-selected');
                        } else {
                            byId(innerId).classList.remove('user-selected');
                        }

                        editFoodModal.setupTitle(SelectionType.DISH_INGREDIENT);

                        if (isSelectionActive(SelectionType.DISH_INGREDIENT)) {
                            let isAllInCurrentGroup = true;
                            for (let diId of getSelectedItems(SelectionType.DISH_INGREDIENT)) {
                                if (allDishIngredients[diId].dish_id !== currentEditingDishId) {
                                    isAllInCurrentGroup = false;
                                    break;
                                }
                            }
                            if (isAllInCurrentGroup) {
                                editFoodModal.titleMoveButton.disabled = true;
                                editFoodModal.titleCopyButton.disabled = true;
                            } else {
                                editFoodModal.titleMoveButton.disabled = false;
                                editFoodModal.titleCopyButton.disabled = false;
                            }
                        }
                    };

                    setupSelection();
                });


               let showDeleteBtn = false;

                dishIngredients = `
                ${
                   HtmlPresets.makeRow(`
                    ${renderDishIngr(dishIngredient)}
                    ${ showDeleteBtn ? `
                    <button class="btn btn-sm btn-danger"
                        onclick="deleteDishIngredientFromDish(${dishIngredient.id})">Удалить</button>
                    ` : '' }
                    `,
                    {fs: 6, ps: 2, id: ingrId, innerId: innerId})
                }
                ` + dishIngredients;
            }

            let allRecipesHtml = '';
            for (let dish of Object.values(allDishes)) {
                if (dish.for_dish !== currDish.id) {
                    continue;
                }
                allRecipesHtml = getDishHtml(dish, false) + allRecipesHtml;
            }

            if (allRecipesHtml) {
                allRecipesHtml += "<br>";
            }


            let parentDishId = currDish.for_dish;
            let parentDishName = '';
            if (parentDishId !== null) {
                let parentDish = allDishes[parentDishId];
                parentDishName = parentDish.name;
            }

            let totalWeightId = generateUUID();
            let totalWeightChangeId = generateUUID();
            let totalWeightChangeSelectTypeId = generateUUID();
            let totalWeightChangeSelectAmountId = generateUUID();
            let totalWeightChangeInputId = generateUUID();
            let totalWeightChangeOkId = generateUUID();

            byId(editDishFoodListId).innerHTML = `

            <div class="d-flex align-items-start">
                <div class="input-group me-2 mb-2-5">
                   <input id="${editDishNameId}" type="text" class="form-control" placeholder="Название">
                </div>
                ${HtmlPresets.switch(editDishOutOfStockId, '', '', false, true, 6)}
            </div>

            <div id="${editDishForDishNameId}" class="${parentDishId ? "" : "d-none"} text-center "
                 style="margin-top: -0.8rem;margin-bottom: -0.4rem">
                    <span class="opacity-50">Рецепт для </span><span class="opacity-75">${parentDishName}</span>
            </div>

            <hr>

            <div class="d-flex">
                <div class="input-group input-group-sm h-100 flex-fill">
                    <select class="form-select" id="${editDishFoodListSelectId}">
                        <option value="" selected disabled></option>
                        ${options}
                    </select>
                    <input id="${editDishAmountInputId}" type="text"
                            class="form-control" placeholder="Кол-во"
                            style="min-width: 4rem;max-width: 4rem;">
                    <span class="input-group-text">гр.</span>
                </div>
                <button id=${editDishAddNewBtnId} class="btn btn-primary">Добавить</button>
            </div>

            ${dishIngredients ? '<hr class="mt-3 mb-1">' : ''}

            <div id=${totalWeightId} class="mt-2 mb-2 fs-5 d-flex justify-content-end align-items-baseline">
                <span>Вес блюда: </span>
                <span class='fs-5 mx-1'>${totalWeight}</span>
                <span>гр.</span>
            </div>

            <div id=${totalWeightChangeId} class="mt-2 mb-2 fs-5 d-flex flex-column align-items-center d-none">
                <div class="d-flex gap-2 justify-content-end align-items-baseline">
                    <span>Убрать</span>
                    ${HtmlPresets.select(totalWeightChangeSelectTypeId, true, `
                        <option value="WATER" selected>Воду</option>
                        <option value="SELF">Себя</option>
                    `)}
                    ${HtmlPresets.select(totalWeightChangeSelectAmountId, true, `
                        <option value="FULL" selected>Полный вес</option>
                        <option value="LEFTOVER">Излишки</option>
                    `)}
                    <input id="${totalWeightChangeInputId}" type="text"
                        class="form-control py-0" placeholder="0"
                        style="min-width: 4rem;max-width: 4rem;">
                    <span>гр.</span>
                </div>
                <div class="w-100">
                    <button id=${totalWeightChangeOkId} class="btn btn-sm btn-secondary w-100">Подтвердить</button>
                </div>

                <hr class="my-1">
            </div>

            <div>${dishIngredients}</div>

            <hr>
            <div class="opacity-50">Рецепты</div>

            <div class="d-flex">
                <div class="input-group">
                    <input id="${editDishAddRecipeNameInputId}" type="text" class="form-control" placeholder="Новый рецепт">
                </div>
                <button id="${editDishAddRecipeBtnId}" class="btn btn-primary ms-2 py-025" disabled>Добавить</button>
            </div>

            <div id="${editDishAllDishRecipesId}">${allRecipesHtml}</div>

            <div class="mt-2">
                ${HtmlPresets.textarea(editDishRecipeInputId, 'Рецепт')}
            </div>

            <div class="mt-2">
                <div id="${editDishEditButtonsId}">
                    <button id="${editDishEditParentId}" class="btn btn-outline-secondary">Изменить связь</button>
                </div>
                <div id="${editDishEditSettingsId}">
                </div>
            </div>


            `;



            byId(editDishNameId).value = currDish.name;
            byId(editDishOutOfStockId).checked = !currDish.out_of_stock;

            const saveDish = async () => {
                let name = byId(editDishNameId).value.trim();
                let outOfStock = !byId(editDishOutOfStockId).checked;

                if (!name.length) {
                    return;
                }

                let result = await _post("/api/dish/edit", {
                    id: dishId,
                    name: name,
                    out_of_stock: outOfStock,
                });

                console.log(result);

                if (result.id) {
                    allDishes[result.id] = result;
                }
            };

            onInput(editDishNameId, saveDish);
            onChange(editDishOutOfStockId, saveDish);

            byId(editDishRecipeInputId).value = currDish.recipe;

            onInput(editDishRecipeInputId, async e => {
                let value = e.value;

                let result = await _post("/api/dish_recipe/edit" ,{
                    id: dishId,
                    recipe: value,
                });

                if (result.id) {
                    allDishes[result.id] = result;
                }
            });

            const match = (params, data) => {
                let query = params?.term ?? '';
                return SearchFilter.search([data], e => e.text, query)[0] ?? null;
            }


            $(`#${editDishFoodListSelectId}`).select2({
                theme: 'bootstrap-5',
                placeholder: "Выбрать пищу",
                dropdownParent: $(`#${editFoodModal.modalId}`),
                matcher: match,
            });

            fixSelect2(true);

            onInput(editDishAmountInputId, e => {
                handleNumberField(e, 0, 9999, true, null, true);
            });

            onClick(editDishAddNewBtnId, async e => {
                let foodIdIngredient = null;
                let dishIdIngredient = null;

                let chosenMeal = byId(editDishFoodListSelectId).value;
                if (!chosenMeal) {
                    return;
                }

                if (chosenMeal.startsWith("FOOD_")) {
                    foodIdIngredient = parseInt(chosenMeal.substring(5));
                } else if (chosenMeal.startsWith("DISH_")) {
                    dishIdIngredient = parseInt(chosenMeal.substring(5));
                }

                if (foodIdIngredient == null && dishIdIngredient == null) {
                    return;
                }

                let chosenAmount = handleNumberField(editDishAmountInputId, 0, 9999, true, null, true);
                if (chosenAmount == null) {
                    return;
                }

                let result = await _post("/api/dish_ingredient/new", {
                    food_id_ingredient: foodIdIngredient,
                    dish_id_ingredient: dishIdIngredient,
                    dish_id: dishId,
                    amount: chosenAmount,
                });

                if (result.id) {
                    allDishIngredients[result.id] = result;
                }

                renderEditDish();
            });


            onInput(editDishAddRecipeNameInputId, elem => {
               byId(editDishAddRecipeBtnId).disabled=!elem.value.trim();
            });

            onClick(editDishAddRecipeBtnId, async () => {
                let elem = byId(editDishAddRecipeNameInputId);
                let result = await _post("/api/dish/new" ,{
                    name: elem.value.trim(),
                    for_dish: currDish.id,
                    out_of_stock: true,
                });

                if (result.id) {
                    allDishes[result.id] = result;
                }

                renderEditDish();
            });

            setDishesCallbacks((dishId) => {
                let totalWeight = calcDishTotalWeight(dishId);
                if (totalWeight > 0) {
                    let dish = allDishes[dishId];
                    autoSelectDish(dish);
                    byId(editDishAmountInputId).value = totalWeight;
                }
            });

            onClick(totalWeightId, () => {
                showElem(totalWeightChangeId);
                hideElem(totalWeightId);
                byId(totalWeightChangeInputId).focus();
            });

            onInput(totalWeightChangeInputId, () => {
                handleNumberField(totalWeightChangeInputId, 1, 9999, true, null, false);
            });

            onClick(totalWeightChangeOkId , async () => {
                let chosenWeightType = byId(totalWeightChangeSelectTypeId).value;
                let chosenWeightAmount = byId(totalWeightChangeSelectAmountId).value;
                let chosenAmount = handleNumberField(totalWeightChangeInputId, 1, 9999, true, null, true);
                if (chosenAmount == null) {
                    if (chosenWeightAmount === "FULL") {
                        chosenAmount = totalWeight;
                    } else {
                        chosenAmount = 0;
                    }
                }

                let newIngredients = [];

                let changed = chosenWeightAmount === "FULL"
                        ? chosenAmount - totalWeight
                        : -chosenAmount;

                if (chosenWeightType === "WATER") {
                    let water = Object.values(allFoods).filter(e => e.name === "Вода")[0];
                    if (changed !== 0) {
                        newIngredients.push({
                            food_id_ingredient: water.id,
                            dish_id_ingredient: null,
                            dish_id: dishId,
                            amount: changed,
                        });
                    }

                } else if (chosenWeightType === "SELF") {
                    for (let ingr of currDishIngredients) {
                        let percentOfTotalAmount = ingr.amount / totalWeight;
                        let changeAmount = Math.round(changed * percentOfTotalAmount);
                        if (changeAmount !== 0) {
                            newIngredients.push({
                                food_id_ingredient: ingr.food_id_ingredient,
                                dish_id_ingredient: ingr.dish_id_ingredient,
                                dish_id: dishId,
                                amount: changeAmount,
                            });
                        }
                    }
                }

                if (newIngredients.length) {
                    let results = await _post("/api/dish_ingredient/new_many", newIngredients);
                    if (results) {
                        for (let result of results) {
                            if (result.id) {
                                allDishIngredients[result.id] = result;
                            }
                        }
                    }
                }

                hideElem(totalWeightChangeId);
                showElem(totalWeightId);

                byId(totalWeightChangeSelectTypeId).value = "WATER";
                byId(totalWeightChangeSelectAmountId).value = "FULL";
                byId(totalWeightChangeInputId).value = "";

                renderEditDish();
            });



            onClick(editDishEditParentId, () => {
                showElem(editDishEditSettingsId);
                hideElem(editDishEditButtonsId);

                let NO_PARENT = 'NO-PARENT';
                let options = `
                <option value="${NO_PARENT}_0">Без связи</option>
                `;
                let elems = getItemsList({
                    foodFilter: ALWAYS_FALSE,
                    dishFilter: ALWAYS_TRUE,
                });

                // Build the options string
                for (let elem of elems) {
                    options += `
                    <option value="${elem.type}_${elem.id}">${elem.name}</option>
                    `;
                }

                byId(editDishEditSettingsId).innerHTML = `
                <div class="d-flex">
                    <div class="input-group input-group-sm h-100 flex-fill">
                        <select class="form-select" id="${editDishEditParentSelectId}">
                            <option value="" selected disabled></option>
                            ${options}
                        </select>
                    </div>
                    <button id=${editDishEditParentConfirmId} class="btn btn-primary">Подтвердить</button>
                </div>
                `;

                $(`#${editDishEditParentSelectId}`).select2({
                    theme: 'bootstrap-5',
                    placeholder: "Выберите блюдо",
                    dropdownParent: $(`#${editFoodModal.modalId}`),
                    matcher: match,
                });

                fixSelect2(true);

                onClick(editDishEditParentConfirmId, async () => {
                    let chosenParent = byId(editDishEditParentSelectId).value;
                    if (!chosenParent) {
                        return;
                    }

                    let [type, id] = chosenParent.split("_");
                    let newParentId;
                    if (type === "FOOD") {
                        return;
                    } else if (type === "DISH") {
                        newParentId = allDishes[id].id;
                    } else if (type === NO_PARENT) {
                        newParentId = null;
                    } else {
                        throw Error("Unknown type");
                    }

                    let result = await _post("/api/dish/reparent", {
                        dish_id: dishId,
                        new_parent_id: newParentId,
                    });

                    if (result) {
                        allDishes[result.id] = result;
                        renderEditDish();
                    }
                });

            });

        };
    }


</script>
